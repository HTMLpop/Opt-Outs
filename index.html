<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opt-Out Dashboard</title>
  <style>
    :root { --bg:#0b0f14; --card:#111822; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa; --ok:#22c55e; --warn:#eab308; --bad:#ef4444; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; z-index:30; background:linear-gradient(to bottom, #0b0f14cc, #0b0f1400); backdrop-filter: blur(8px); padding:16px; border-bottom:1px solid #1f2937; }
    h1 { margin:0 0 6px; font-size:22px; letter-spacing:.2px; }
    .sub { color:var(--muted); font-size:13px; margin-top:2px; }
    .container { display:grid; grid-template-columns: 310px 1fr; gap:16px; padding:16px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:14px; }
    .card h2 { font-size:16px; margin:0 0 10px; }
    label { display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input[type="text"], input[type="email"], input[type="tel"] , textarea, select {
      width:100%; background:#0d141d; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:10px 12px; outline:none;
    }
    input::placeholder, textarea::placeholder { color:#475569; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid #1f2937; background:#0d141d; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; text-decoration:none; font-size:13px; }
    .btn:hover { border-color:#334155; }
    .btn-primary { background: #0f172a; border-color:#334155; }
    .btn-accent { background: #0b1220; border-color:#1d4ed8; color:#bfdbfe; }
    .pill { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid #334155; color:#cbd5e1; }
    .pill.ok { border-color:#14532d; color:#86efac; }
    .pill.warn { border-color:#7c2d12; color:#fdba74; }
    .pill.bad { border-color:#7f1d1d; color:#fecaca; }
    table { width:100%; border-collapse:separate; border-spacing:0 8px; }
    thead th { text-align:left; font-size:12px; color:#9ca3af; font-weight:600; padding:0 8px 8px; }
    tbody tr { background: var(--card); border:1px solid #1f2937; }
    tbody td { padding:10px 8px; vertical-align:top; border-top:1px solid #1f2937; border-bottom:1px solid #1f2937; }
    tbody tr td:first-child { border-left:1px solid #1f2937; border-top-left-radius:12px; border-bottom-left-radius:12px; }
    tbody tr td:last-child { border-right:1px solid #1f2937; border-top-right-radius:12px; border-bottom-right-radius:12px; }
    .table-actions { display:flex; flex-wrap:wrap; gap:8px; }
    details { margin-top:6px; }
    .footer { padding:16px; color:#94a3b8; font-size:12px; border-top:1px solid #1f2937; }
    .grid-3 { display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; }
    .sticky-col { position:sticky; top:80px; height: calc(100vh - 120px); overflow:auto; padding-bottom:60px; }
    .status { width: 150px; }
    .muted { color:#9ca3af; font-size:12px; }
    .spacer { height: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Opt-Out Dashboard</h1>
    <div class="sub">Local-first tool to guide and track data-broker opt-outs. Your profile & progress are stored in your browser only.</div>
  </header>

  <div class="container">
    <aside class="sticky-col">
      <div class="card">
        <h2>Your Profile</h2>
        <label>Full name</label>
        <input id="p_name" type="text" placeholder="Jane Q. Doe" />

        <div class="row">
          <div>
            <label>Email</label>
            <input id="p_email" type="email" placeholder="jane@example.com" />
          </div>
          <div>
            <label>Phone</label>
            <input id="p_phone" type="tel" placeholder="(555) 555-5555" />
          </div>
        </div>

        <label>Street address</label>
        <input id="p_addr1" type="text" placeholder="123 Main St Apt 4B" />
        <div class="row">
          <div><label>City</label><input id="p_city" type="text" placeholder="Lakeland" /></div>
          <div><label>State</label><input id="p_state" type="text" placeholder="FL" /></div>
        </div>
        <div class="row">
          <div><label>ZIP</label><input id="p_zip" type="text" placeholder="33801" /></div>
          <div><label>Date of birth (optional)</label><input id="p_dob" type="text" placeholder="YYYY-MM-DD" /></div>
        </div>
        <div class="spacer"></div>
        <div class="table-actions">
          <button class="btn btn-primary" id="saveProfile">Save profile</button>
          <button class="btn" id="clearProfile">Clear</button>
        </div>
        <div id="profileMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Filters</h2>
        <label>Search (broker or parent)</label>
        <input id="f_search" type="text" placeholder="Search brokers or parent companies…" />

        <div class="row">
          <div>
            <label>Cascade</label>
            <select id="f_cascade">
              <option value="">All</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
          <div>
            <label>Method</label>
            <select id="f_method">
              <option value="">All</option>
            </select>
          </div>
        </div>

        <label>Group (Parent)</label>
        <select id="f_group"></select>

        <div class="spacer"></div>
        <div class="table-actions">
          <button class="btn" id="resetFilters">Reset filters</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Progress</h2>
        <div class="table-actions">
          <button class="btn" id="exportStatus">Export status</button>
          <label class="btn" for="importStatusFile" style="cursor:pointer;">Import status</label>
          <input type="file" id="importStatusFile" accept="application/json" style="display:none" />
        </div>
        <div class="spacer"></div>
        <div class="muted">Statuses are saved in your browser. Export a backup if you’ll switch devices.</div>
      </div>
    </aside>

    <main>
      <div class="card">
        <h2>Broker List</h2>
        <div class="muted">Click an opt-out URL to open in a new tab. Use the email buttons to generate a prefilled email template.</div>

        <div style="overflow:auto; margin-top:10px;">
          <table id="tbl">
            <thead>
              <tr>
                <th>Broker</th>
                <th>Parent / Group</th>
                <th>Method</th>
                <th>Cascade</th>
                <th>Actions</th>
                <th>Notes & Steps</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
      <div class="footer">Built for local-first privacy workflows. Many brokers require Captcha or verification; this tool prepares everything and tracks progress.</div>
    </main>
  </div>

<script>
const DATA_URL = "data/brokers.json";

const STATUS_OPTIONS = ["Not started","In progress","Submitted","Verified","Rejected"];
let DATA = [];
let METHODS = [];
let GROUPS = [];
let statusMap = {};
const statusKey = "optout_status_v1";
const profileKey = "optout_profile_v1";

function el(tag, attrs={}, children=[]) {
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => {
    if (k === "class") e.className = v;
    else if (k === "html") e.innerHTML = v;
    else if (k.startsWith("on") && typeof v === "function") e.addEventListener(k.substring(2), v);
    else e.setAttribute(k,v);
  });
  (Array.isArray(children) ? children : [children]).filter(Boolean).forEach(c => e.append(c));
  return e;
}

function loadStatus() {
  try {
    statusMap = JSON.parse(localStorage.getItem(statusKey) || "{}");
  } catch {
    statusMap = {};
  }
}

function saveStatus() {
  localStorage.setItem(statusKey, JSON.stringify(statusMap));
}

function loadProfile() {
  try {
    const p = JSON.parse(localStorage.getItem(profileKey) || "{}");
    ["name","email","phone","addr1","city","state","zip","dob"].forEach(k => {
      const elid = "p_"+k;
      if (p[k] && document.getElementById(elid)) document.getElementById(elid).value = p[k];
    });
  } catch {}
}

function saveProfile() {
  const p = {
    name: document.getElementById("p_name").value.trim(),
    email: document.getElementById("p_email").value.trim(),
    phone: document.getElementById("p_phone").value.trim(),
    addr1: document.getElementById("p_addr1").value.trim(),
    city: document.getElementById("p_city").value.trim(),
    state: document.getElementById("p_state").value.trim(),
    zip: document.getElementById("p_zip").value.trim(),
    dob: document.getElementById("p_dob").value.trim(),
  };
  localStorage.setItem(profileKey, JSON.stringify(p));
  const msg = document.getElementById("profileMsg");
  msg.textContent = "Saved locally.";
  setTimeout(()=> msg.textContent = "", 2000);
}

function clearProfile() {
  localStorage.removeItem(profileKey);
  ["p_name","p_email","p_phone","p_addr1","p_city","p_state","p_zip","p_dob"].forEach(id => document.getElementById(id).value = "");
  const msg = document.getElementById("profileMsg");
  msg.textContent = "Cleared.";
  setTimeout(()=> msg.textContent = "", 2000);
}

function profile() {
  try { return JSON.parse(localStorage.getItem(profileKey) || "{}"); }
  catch { return {}; }
}

function statusKeyFor(row) {
  return `${row["Group Key"]}||${row["Broker Name"]}`;
}

function getStatus(row) {
  const key = statusKeyFor(row);
  return statusMap[key] || "Not started";
}

function setStatus(row, val) {
  const key = statusKeyFor(row);
  statusMap[key] = val;
  saveStatus();
}

function mailtoFor(row) {
  const p = profile();
  const to = row["Opt-Out URL/Email"] && String(row["Opt-Out URL/Email"]).includes("@")
    ? row["Opt-Out URL/Email"].trim() : "";
  const subject = `Opt-Out Request - ${row["Broker Name"]}`;
  const bodyLines = [
    `To ${row["Broker Name"]} Privacy Team,`,
    ``,
    `I am requesting removal of my personal information from your data products and marketing databases pursuant to applicable privacy laws.`,
    ``,
    `Full name: ${p.name || ""}`,
    `Email: ${p.email || ""}`,
    `Phone: ${p.phone || ""}`,
    `Address: ${p.addr1 || ""}, ${p.city || ""}, ${p.state || ""} ${p.zip || ""}`,
    `Date of birth: ${p.dob || ""}`,
    ``,
    `If you share a common database with affiliated brands or child companies, please apply this request across all affiliated properties.`,
    `Please confirm completion and provide a description of any remaining data retained for legal compliance.`,
    ``,
    `Thank you,`,
    `${p.name || ""}`
  ];
  const body = encodeURIComponent(bodyLines.join("\n"));
  const params = `?subject=${encodeURIComponent(subject)}&body=${body}`;
  return `mailto:${encodeURIComponent(to)}${params}`;
}

function copyTemplate(row) {
  const p = profile();
  const text = [
    `To ${row["Broker Name"]} Privacy Team,`,
    ``,
    `I am requesting removal of my personal information from your data products and marketing databases pursuant to applicable privacy laws.`,
    ``,
    `Full name: ${p.name || ""}`,
    `Email: ${p.email || ""}`,
    `Phone: ${p.phone || ""}`,
    `Address: ${p.addr1 || ""}, ${p.city || ""}, ${p.state || ""} ${p.zip || ""}`,
    `Date of birth: ${p.dob || ""}`,
    ``,
    `If you share a common database with affiliated brands or child companies, please apply this request across all affiliated properties.`,
    `Please confirm completion and provide a description of any remaining data retained for legal compliance.`,
    ``,
    `Thank you,`,
    `${p.name || ""}`
  ].join("\n");
  navigator.clipboard.writeText(text).then(()=>{});
}

function buildMethodOptions() {
  const methods = [...new Set(DATA.map(r => (r["Opt-Out Method"]||"").trim()).filter(Boolean))].sort();
  METHODS = methods;
  const sel = document.getElementById("f_method");
  methods.forEach(m => sel.append(el("option",{value:m, html:m})));
}

function buildGroupOptions() {
  const groups = [...new Set(DATA.map(r => (r["Parent Company"]||"").trim() || r["Group Key"]))].sort((a,b)=>a.localeCompare(b));
  GROUPS = groups;
  const sel = document.getElementById("f_group");
  sel.innerHTML = "";
  sel.append(el("option",{value:"", html:"All"}));
  groups.forEach(g => sel.append(el("option",{value:g, html:g})));
}

function cascadePill(val){
  const txt = String(val||"Unknown");
  let cls = "pill";
  if (txt.toLowerCase().startsWith("yes")) cls += " ok";
  else if (txt.toLowerCase().startsWith("no")) cls += " bad";
  else cls += " warn";
  return el("span",{class:cls, html:txt});
}

function renderRow(row){
  const tb = document.getElementById("tbody");
  const tr = el("tr");

  // Broker cell
  const broker = el("td",{},[
    el("div",{html:`<strong>${row["Broker Name"]||""}</strong>`}),
    el("div",{class:"muted", html: row["Relationship Type"]||""})
  ]);

  // Parent cell
  const parent = el("td",{},[
    el("div",{html: (row["Parent Company"]||"") || row["Group Key"] || ""}),
    el("div",{class:"muted", html:`Group: ${(row["Group Key"]||"")}`})
  ]);

  // Method cell
  const method = el("td",{},[
    el("div",{html: row["Opt-Out Method"]||""}),
    (row["Opt-Out URL/Email"]||"").trim()
      ? el("div",{class:"muted", html: row["Opt-Out URL/Email"]})
      : null
  ]);

  // Cascade cell
  const cascade = el("td",{},[ cascadePill(row["Cascade Opt-Out?"]) ]);

  // Actions cell
  const actions = el("td",{},[
    el("div",{class:"table-actions"},[
      (row["Opt-Out URL/Email"]||"").startsWith("http")
        ? el("a",{href: row["Opt-Out URL/Email"], target:"_blank", class:"btn btn-accent"},["Open opt-out URL"])
        : null,
      (row["Opt-Out URL/Email"]||"").includes("@")
        ? el("a",{href: mailtoFor(row), class:"btn"},["Email request"])
        : null,
      el("button",{class:"btn", onclick:()=>copyTemplate(row)},["Copy request text"]),
    ])
  ]);

  // Notes cell
  const notesText = [row["Notes"]||"", row["How to Initiate Opt-Out"]||""].filter(Boolean).join(" \n ");
  const notes = el("td",{},[
    notesText.length > 180
      ? el("details",{},[
          el("summary",{html: (notesText.slice(0,180)+"…").replace(/\n/g,"<br/>")}),
          el("div",{class:"muted", html: notesText.replace(/\n/g,"<br/>")})
        ])
      : el("div",{class:"muted", html: notesText.replace(/\n/g,"<br/>")})
  ]);

  // Status cell
  const statusSel = el("select",{class:"status"});
  STATUS_OPTIONS.forEach(s => statusSel.append(el("option",{value:s, html:s})));
  statusSel.value = getStatus(row);
  statusSel.addEventListener("change", ()=> setStatus(row, statusSel.value));
  const status = el("td",{},[statusSel]);

  [broker,parent,method,cascade,actions,notes,status].forEach(td => tr.append(td));
  tb.append(tr);
}

function applyFilters(){
  const q = document.getElementById("f_search").value.trim().toLowerCase();
  const cas = document.getElementById("f_cascade").value;
  const meth = document.getElementById("f_method").value;
  const grp = document.getElementById("f_group").value;

  const filtered = DATA.filter(r => {
    const hay = [r["Broker Name"], r["Parent Company"], r["Group Key"]].join(" ").toLowerCase();
    if (q && !hay.includes(q)) return false;
    if (cas) {
      const c = String(r["Cascade Opt-Out?"]||"").toLowerCase();
      if (cas==="Yes" && !c.startsWith("yes")) return false;
      if (cas==="No" && !c.startsWith("no")) return false;
      if (cas==="Unknown" && !c.startsWith("unknown")) return false;
    }
    if (meth && String(r["Opt-Out Method"]||"") !== meth) return false;
    if (grp && ![r["Parent Company"], r["Group Key"]].includes(grp)) return false;
    return true;
  });

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  filtered.forEach(renderRow);
}

async function init(){
  loadStatus();
  loadProfile();
  const res = await fetch(DATA_URL);
  DATA = await res.json();
  buildMethodOptions();
  buildGroupOptions();
  applyFilters();

  document.getElementById("f_search").addEventListener("input", applyFilters);
  document.getElementById("f_cascade").addEventListener("change", applyFilters);
  document.getElementById("f_method").addEventListener("change", applyFilters);
  document.getElementById("f_group").addEventListener("change", applyFilters);
  document.getElementById("resetFilters").addEventListener("click", ()=>{
    document.getElementById("f_search").value = "";
    document.getElementById("f_cascade").value = "";
    document.getElementById("f_method").value = "";
    document.getElementById("f_group").value = "";
    applyFilters();
  });

  document.getElementById("saveProfile").addEventListener("click", saveProfile);
  document.getElementById("clearProfile").addEventListener("click", clearProfile);

  document.getElementById("exportStatus").addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(statusMap, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "optout_status_export.json";
    a.click();
  });

  document.getElementById("importStatusFile").addEventListener("change", async (ev)=>{
    const f = ev.target.files[0];
    if (!f) return;
    const txt = await f.text();
    try {
      const obj = JSON.parse(txt);
      statusMap = obj;
      saveStatus();
      applyFilters();
    } catch(e){ alert("Invalid JSON"); }
  });
}

init();
</script>
</body>
</html>
